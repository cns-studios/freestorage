<!DOCTYPE html>
<html>
<head>
    <title>FreeStorage // Web</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Geist:wght@100..900&family=Inter:wght@100..900&display=swap');

        :root {
            --bg-color: #000000;
            --sidebar-color: #000000;
            --card-color: #0a0a0a;
            --text-primary: #ededed;
            --text-secondary: #888888;
            --text-tertiary: #444444;
            --accent-color: #ffffff;
            --accent-hover: #e5e5e5;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --border-color: #333333;
            --hover-bg: #1a1a1a;
            --input-bg: #0a0a0a;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Geist', 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 14px;
        }

        #auth-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; justify-content: center; align-items: center; z-index: 200; }
        .auth-card { background: var(--bg-color); padding: 2.5rem; width: 320px; display: flex; flex-direction: column; gap: 1rem; }
        .auth-header { margin-bottom: 1rem; text-align: center; }
        h2 { margin: 0; color: var(--text-primary); font-weight: 600; font-size: 1.5rem; letter-spacing: -0.02em; }
        .subtitle { color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem; }
        input { width: 100%; padding: 0.75rem 1rem; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); box-sizing: border-box; font-family: inherit; font-size: 0.875rem; }
        button { width: 100%; padding: 0.75rem 1rem; background: var(--accent-color); color: #000; border: 1px solid var(--accent-color); border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.875rem; transition: all 0.15s ease; display: flex; justify-content: center; align-items: center; gap: 8px; }
        button:hover { background: var(--accent-hover); }
        button.secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }

        #app-screen { display: none; width: 100%; height: 100%; }
        .sidebar { width: 240px; background: var(--sidebar-color); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 1.5rem 1rem; }
        .logo { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 2rem; display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 24px; height: 24px; background: var(--text-primary); color: black; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
        .nav-item { padding: 0.5rem 0.75rem; margin-bottom: 2px; border-radius: 6px; cursor: pointer; color: var(--text-secondary); display: flex; align-items: center; gap: 12px; }
        .nav-item:hover, .nav-item.active { background: var(--hover-bg); color: var(--text-primary); }
        .main-content { flex-grow: 1; padding: 2rem 3rem; overflow-y: auto; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: var(--card-color); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); }
        .stat-label { color: var(--text-secondary); font-size: 0.875rem; }
        .stat-value { font-size: 1.75rem; font-weight: 600; color: var(--text-primary); }

        .file-table { width: 100%; border-collapse: collapse; }
        .file-table th { text-align: left; padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color); color: var(--text-secondary); font-size: 0.75rem; text-transform: uppercase; }
        .file-table td { padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border-color); }
        .icon { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }
        
        .footer { position: fixed; bottom: 0; width: 100%; padding: 1rem 0; background: var(--bg-color); border-top: 1px solid var(--border-color); display: flex; justify-content: center; gap: 2rem; color: var(--text-tertiary); font-size: 0.75rem; z-index: 150; }
        .footer a { color: var(--text-tertiary); text-decoration: none; transition: color 0.15s ease; }
        .footer a:hover { color: var(--text-secondary); }

        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .loader { width: 24px; height: 24px; border: 2px solid var(--border-color); border-top-color: var(--text-primary); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="loader"></div></div>

    <footer class="footer">
        <span>&copy; 2026 FreeStorage</span>
        <a href="/tos.html">Terms of Service</a>
        <a href="/policy.html">Privacy Policy</a>
    </footer>

    <div id="auth-screen">
        <div class="auth-card">
            <div class="auth-header">
                <h2>FreeStorage // Web</h2>
                <div class="subtitle">View and download your files</div>
            </div>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <p id="auth-msg" style="color: var(--danger-color); font-size: 0.75rem; text-align: center;"></p>
            <button onclick="login()">Log In</button>
            <button class="secondary" onclick="window.location.href='/download-app'">Download App to Register</button>
        </div>
    </div>

    <div id="app-screen">
        <div class="sidebar">
            <div class="logo">FreeStorage</div>
            <div class="nav-item active" onclick="switchTab('dashboard')">Overview</div>
            <div class="nav-item" onclick="switchTab('files')">Files</div>
            <div style="flex-grow: 1;"></div>
            <div class="nav-item" onclick="logout()" style="color: var(--danger-color);">Log Out</div>
        </div>
        <div class="main-content">
            <div id="dashboard" class="tab-content active">
                <h1>Overview</h1>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Storage Used</div>
                        <div class="stat-value" id="storage-used">0 GB</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Limit</div>
                        <div class="stat-value" id="storage-limit">10 GB</div>
                    </div>
                </div>
                <div style="padding: 1.5rem; background: var(--hover-bg); border-radius: 8px; border: 1px solid var(--border-color); color: var(--text-secondary);">
                    <strong>Web Mode:</strong> You are in read-only mode. To upload files or earn storage rewards, please use the desktop application.
                </div>
            </div>

            <div id="files" class="tab-content" style="display:none">
                <h1>Files</h1>
                <table class="file-table">
                    <thead><tr><th>Name</th><th>Size</th><th style="text-align:right">Action</th></tr></thead>
                    <tbody id="file-list-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const USERDATA_URL = window.location.origin + '/api/userdata-server';
        const CONTENT_URL = window.location.origin + '/api/content-server';
        const WS_URL = (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/api/content-server-ws';

        let ws = null;
        let currentUser = {};
        const pendingDownloads = new Map();

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }

        async function login() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            showLoading(true);
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: u, password: p })
            });
            showLoading(false);
            const data = await res.json();
            if (data.success) location.reload();
            else document.getElementById('auth-msg').innerText = data.error;
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            location.reload();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            if (tabId === 'files') refreshFiles();
        }

        async function refreshFiles() {
            const res = await fetch(`${CONTENT_URL}/files/user/${currentUser.userId}`, {
                headers: { 'Authorization': `Bearer ${currentUser.token}` }
            });
            const data = await res.json();
            const tbody = document.getElementById('file-list-body');
            tbody.innerHTML = '';
            data.files.forEach(file => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${file.filename}</td>
                    <td>${(file.file_size_bytes / (1024*1024)).toFixed(2)} MB</td>
                    <td style="text-align:right"><button style="width:auto; padding: 4px 12px;" onclick="downloadFile('${file.id}')">Download</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function downloadFile(fileId) {
            showLoading(true);
            try {
                const res = await fetch(`${CONTENT_URL}/download/${fileId}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                const { chunks } = await res.json();
                const chunkBuffers = [];

                for (const chunk of chunks) {
                    const data = await requestChunk(chunk.chunkId);
                    
                    const hash = await crypto.subtle.digest('SHA-256', data);
                    const hashHex = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
                    
                    if (hashHex !== chunk.chunkHash) throw new Error('Integrity check failed');
                    chunkBuffers.push(data);
                }

                const fullEncrypted = new Uint8Array(chunkBuffers.reduce((acc, curr) => acc + curr.byteLength, 0));
                let offset = 0;
                chunkBuffers.forEach(buf => {
                    fullEncrypted.set(new Uint8Array(buf), offset);
                    offset += buf.byteLength;
                });

                const blob = new Blob([fullEncrypted], { type: 'application/octet-stream' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `file_${fileId}.bin`;
                a.click();
            } catch (e) {
                alert('Download failed: ' + e.message);
            }
            showLoading(false);
        }

        function requestChunk(chunkId) {
            return new Promise((resolve, reject) => {
                const requestId = Math.random().toString(36).substring(7);
                const timeout = setTimeout(() => {
                    pendingDownloads.delete(requestId);
                    reject(new Error('Timeout'));
                }, 10000);

                pendingDownloads.set(requestId, { resolve, reject, timeout });
                ws.send(JSON.stringify({ type: 'request_chunk', chunkId, requestId }));
            });
        }

        function initWS() {
            ws = new WebSocket(WS_URL);
            ws.onopen = () => {
                ws.send(JSON.stringify({ type: 'auth', userId: currentUser.userId, peerSecret: currentUser.peerSecret }));
            };
            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                if (msg.type === 'chunk_data') {
                    for (let [reqId, pend] of pendingDownloads) {
                        clearTimeout(pend.timeout);
                        const binary = atob(msg.chunkData);
                        const bytes = new Uint8Array(binary.length);
                        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                        pend.resolve(bytes.buffer);
                        pendingDownloads.delete(reqId);
                        break;
                    }
                }
            };
        }

        window.onload = () => {
            const token = getCookie('token');
            if (token) {
                currentUser = {
                    token,
                    userId: getCookie('userId'),
                    encryptionKey: getCookie('encryptionKey'),
                    peerSecret: getCookie('peerSecret'),
                    username: getCookie('username')
                };
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-screen').style.display = 'flex';
                initWS();
                
                fetch(`${USERDATA_URL}/profile`, { headers: { 'Authorization': `Bearer ${token}` }})
                    .then(r => r.json())
                    .then(p => {
                        document.getElementById('storage-used').innerText = p.storage_used_gb.toFixed(2) + ' GB';
                        document.getElementById('storage-limit').innerText = p.storage_limit_gb + ' GB';
                    });
            }
        };
    </script>
</body>
</html>